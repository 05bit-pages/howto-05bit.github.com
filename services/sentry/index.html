<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>How To</title>
    <link rel="icon" type="image/png" href="/favicon.png?_=1" />
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css?_=1">
    <link rel="stylesheet" href="/assets/css/pygments.css">
    <link rel="stylesheet" href="/assets/css/docta.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
</head>
<body>

<nav class="navbar navbar-default navbar-static-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            
            <a class="navbar-brand logo" href="/" style="background-image: url(/assets/img/question.svg); width: 55px; background-size: 65%;"></a>
            
            <a class="navbar-brand" href="/">How To</a>
        </div>

        
    </div>
</nav>


<div class="container">
    <div class="row">
        <div class="col-sm-9">
            
    <h1>How to setup Sentry server?</h1>
<p>The instruction is tested under <strong>Ubuntu 14.04 LTS</strong>.</p>
<p>Login under <code>sentry</code> user with sudo rights.</p>
<p>Then set up server locales to use UTF-8:</p>
<div class="highlight"><pre><span></span>sudo locale-gen en_US.UTF-8
sudo dpkg-reconfigure locales
sudo update-locale <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8 <span class="nv">LANGUAGE</span><span class="o">=</span>en_US.UTF-8 <span class="nv">LC_ALL</span><span class="o">=</span>en_US.UTF-8
</pre></div>
<p><strong>Check your current locale with <code>locale</code> command!</strong> If it's not UTF-8, try re-login.</p>
<ol>
<li><p>Add extra repositories:</p>
<div class="highlight"><pre><span></span>sudo apt-get install -y software-properties-common
sudo add-apt-repository -y ppa:chris-lea/redis-server
</pre></div>
</li>
<li><p>Install Redis and PostgreSQL:</p>
<div class="highlight"><pre><span></span>sudo apt-get install -y redis-server
sudo apt-get install -y postgresql-client postgresql-9.3 postgresql-server-dev-9.3 postgresql-common postgresql-contrib
</pre></div>
</li>
<li><p>Install required packages:</p>
<div class="highlight"><pre><span></span>sudo apt-get install -y python-setuptools python-pip python-dev libxslt1-dev gcc libffi-dev libjpeg-dev libxml2-dev libxslt-dev libyaml-dev python-virtualenv
</pre></div>
</li>
<li><p>Install Nginx</p>
<div class="highlight"><pre><span></span>sudo apt-get remove -y apache2
sudo apt-get install -y nginx-full
</pre></div>
</li>
<li><p>Install and activate Virtualenv:</p>
<div class="highlight"><pre><span></span>mkdir -p ~/env <span class="o">&amp;&amp;</span> virtualenv ~/env/sentry
<span class="nb">source</span> ~/env/sentry/bin/activate
</pre></div>
</li>
<li><p>Install Sentry</p>
<div class="highlight"><pre><span></span>pip install sentry
</pre></div>
</li>
<li><p>Init Sentry config</p>
<div class="highlight"><pre><span></span>mkdir -p ~/etc/sentry <span class="o">&amp;&amp;</span> sentry init ~/etc/sentry
</pre></div>
</li>
<li><p>Setup database</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> -n <span class="s2">&quot;New database user password: &quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">read</span> -s PASSWORD <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="o">&amp;&amp;</span><span class="se">\</span>
sudo -u postgres createuser -dRS sentry <span class="o">&amp;&amp;</span><span class="se">\</span>
sudo -u postgres psql -c <span class="s2">&quot;ALTER ROLE sentry WITH PASSWORD &#39;</span><span class="nv">$PASSWORD</span><span class="s2">&#39;;&quot;</span> <span class="o">&amp;&amp;</span><span class="se">\</span>
<span class="nb">echo</span> <span class="s2">&quot;127.0.0.1:*:sentry:sentry:</span><span class="si">${</span><span class="nv">PASSWORD</span><span class="si">}</span><span class="s2">&quot;</span> &gt; ~/.pgpass <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="o">&amp;&amp;</span><span class="se">\</span>
chmod <span class="m">600</span> ~/.pgpass <span class="o">&amp;&amp;</span><span class="se">\</span>
createdb -E utf-8 sentry
</pre></div>
</li>
<li><p>Update Sentry config</p>
<div class="highlight"><pre><span></span>vi ~/etc/sentry/sentry.conf.py
</pre></div>
<p>database config:</p>
<div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
     <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;sentry.db.postgres&#39;</span><span class="p">,</span>
     <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;sentry&#39;</span><span class="p">,</span>
     <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;sentry&#39;</span><span class="p">,</span>
     <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
     <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
     <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>queue config:</p>
<div class="highlight"><pre><span></span><span class="n">BROKER_URL</span> <span class="o">=</span> <span class="s1">&#39;redis://127.0.0.1:6379/0&#39;</span>
</pre></div>
<p>host config:</p>
<div class="highlight"><pre><span></span><span class="n">SENTRY_WEB_HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</pre></div>
<p>disable sign ups:</p>
<div class="highlight"><pre><span></span><span class="c1"># Disable registrations</span>
<span class="n">SENTRY_FEATURES</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s1">&#39;auth:register&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
 <span class="s1">&#39;social-auth:register&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</li>
<li><p>Run Sentry database migrations and create admin user:</p>
<div class="highlight"><pre><span></span><span class="nv">SENTRY_CONF</span><span class="o">=</span><span class="nv">$HOME</span>/etc/sentry sentry upgrade
<span class="nv">SENTRY_CONF</span><span class="o">=</span><span class="nv">$HOME</span>/etc/sentry sentry createuser
</pre></div>
</li>
<li><p>Setup Nginx web proxy, no SSL</p>
<p>Paste config to <code>~/etc/nginx/sentry</code>:</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">sentry.MYSITE.com</span><span class="p">;</span>

    <span class="kn">root</span> <span class="s">/home/sentry/www</span><span class="p">;</span>

    <span class="kn">location</span> <span class="p">~</span> <span class="sr">^/(\.well-known)/</span> <span class="p">{</span>
        <span class="kn">root</span> <span class="s">/home/sentry/www</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
        <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:9000</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>test config and restart:</p>
<div class="highlight"><pre><span></span>sudo ln -s /home/sentry/etc/nginx/sentry /etc/nginx/sites-enabled/sentry
sudo nginx -t
sudo service nginx restart
</pre></div>
</li>
<li><p>Install LetsEncrypt certificate</p>
<div class="highlight"><pre><span></span>mkdir src <span class="o">&amp;&amp;</span> git clone https://github.com/letsencrypt/letsencrypt src/letsencrypt
<span class="nb">cd</span> src/letsencrypt <span class="o">&amp;&amp;</span> ./letsencrypt-auto --help
mkdir -p /home/sentry/www
./letsencrypt-auto certonly --webroot -w /home/sentry/www -d sentry.MYSITE.com
</pre></div>
</li>
<li><p>Setup Nginx web proxy, with SSL</p>
<p>Paste config to <code>~/etc/nginx/sentry</code>:</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">sentry.MYSITE.com</span><span class="p">;</span>
    <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">sentry.MYSITE.com</span><span class="p">;</span>
    <span class="kn">client_max_body_size</span> <span class="mi">4m</span><span class="p">;</span>

    <span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/sentry.MYSITE.com/fullchain.pem</span><span class="p">;</span>
    <span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/sentry.MYSITE.com/privkey.pem</span><span class="p">;</span>
    <span class="kn">ssl_protocols</span> <span class="s">TLSv1</span> <span class="s">TLSv1.1</span> <span class="s">TLSv1.2</span><span class="p">;</span>
    <span class="kn">ssl_prefer_server_ciphers</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">ssl_ciphers</span> <span class="s">&#39;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&#39;</span><span class="p">;</span>

    <span class="kn">root</span> <span class="s">/home/sentry/www</span><span class="p">;</span>

    <span class="kn">location</span> <span class="p">~</span> <span class="sr">^/(\.well-known)/</span> <span class="p">{</span>
        <span class="kn">root</span> <span class="s">/home/sentry/www</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
        <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:9000</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>then test config and restart:</p>
<div class="highlight"><pre><span></span>sudo nginx -t
sudo service nginx restart
</pre></div>
</li>
<li><p>Add UpStart scripts for main app</p>
<p>Add config with <code>sudo vi /etc/init/sentry.conf</code>:</p>
<div class="highlight"><pre><span></span>description <span class="s2">&quot;Sentry web application&quot;</span>
start on runlevel <span class="o">[</span>2345<span class="o">]</span>
stop on runlevel <span class="o">[</span>016<span class="o">]</span>
respawn

setuid sentry
setgid sentry

env <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
env <span class="nv">SENTRY_CONF</span><span class="o">=</span>/home/sentry/etc/sentry

script
    <span class="nb">exec</span> /home/sentry/env/sentry/bin/sentry run web
end script
</pre></div>
<p>start the service:</p>
<div class="highlight"><pre><span></span>sudo service sentry start
</pre></div>
</li>
<li><p>Add UpStart scripts for worker</p>
<p>Add config with <code>sudo vi /etc/init/sentry-worker.conf</code>:</p>
<div class="highlight"><pre><span></span>description <span class="s2">&quot;Sentry workers&quot;</span>
start on runlevel <span class="o">[</span>2345<span class="o">]</span>
stop on runlevel <span class="o">[</span>016<span class="o">]</span>
respawn

setuid sentry
setgid sentry

env <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
env <span class="nv">SENTRY_CONF</span><span class="o">=</span>/home/sentry/etc/sentry

script
    <span class="nb">exec</span> /home/sentry/env/sentry/bin/sentry run worker
end script
</pre></div>
<p>start the worker:</p>
<div class="highlight"><pre><span></span>sudo service sentry-worker start
</pre></div>
</li>
<li><p>Add UpStart scripts for cron</p>
<p>Add config with <code>sudo vi /etc/init/sentry-cron.conf</code>:</p>
<div class="highlight"><pre><span></span>description <span class="s2">&quot;Sentry cron&quot;</span>
start on runlevel <span class="o">[</span>2345<span class="o">]</span>
stop on runlevel <span class="o">[</span>016<span class="o">]</span>
respawn

setuid sentry
setgid sentry

env <span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
env <span class="nv">SENTRY_CONF</span><span class="o">=</span>/home/sentry/etc/sentry

script
    <span class="nb">exec</span> /home/sentry/env/sentry/bin/sentry run cron
end script
</pre></div>
<p>start the Sentry cron:</p>
<div class="highlight"><pre><span></span>sudo service sentry-cron start
</pre></div>
</li>
</ol>
<h3>Related articles</h3>
<ul>
<li><a href="https://docs.getsentry.com/on-premise/server/installation/">https://docs.getsentry.com/on-premise/server/installation/</a></li>
</ul>


        </div>
        <div class="col-sm-3">
            
            <div class="panel panel-default">
                <div class="panel-body">
                    <ul class="nav nav-pills nav-stacked nav-tree">
                        <li >
                            <a href="/" class="index">How To</a>
                            <hr>
                        </li>
                        
                            
                            <li >
                                <a href="/linux/" class="index">Linux Tips</a>
                                            
                            </li>
                            
                            <li >
                                <a href="/services/" class="index">Services</a>
                                
                                <ul class="nav nav-pills nav-stacked">
                                    
                                    <li class="active">
                                        <a href="/services/sentry/">Sentry</a>
                                    </li>
                                    
                                </ul>
                                            
                            </li>
                            
                            <li >
                                <a href="/docker/" >Docker</a>
                                            
                            </li>
                            
                        
                    </ul>
                </div>
            </div>
            
        </div>
    </div>
</div>

<div class="container footer">
    
    <hr>
    <p class="text-muted">&copy; 2016 05Bit</p>
    
</div>
</body>
</html>